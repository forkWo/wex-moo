name: Wex JSON Upload

on:
  push:
    branches:
      - mian
  workflow_dispatch:
  schedule:
    - cron: '*/50 * * * *'

env:
  ORIGINAL_JSON: "9280.json"
  FINAL_JSON: "wex.json"
  SWITCH_DOUBAN: ${{ secrets.SWITCH_DOUBAN }}
  #æ¨èé“¾æ¥
  DOUBAN_ext: ${{ secrets.DOUBAN_ext }}
  #éœ€è¦åˆ é™¤çš„
  key_DELETE: ${{ secrets.key_DELETE }}
  #å‡¯é€Ÿè·¯å¾„
  KSTORE_ID: ${{ secrets.KSTORE_ID }}
  #å‡¯é€Ÿå¯†é’¥
  KSTORE_TOKEN: ${{ secrets.KSTORE_TOKEN }}
  # ä»ç¯å¢ƒå˜é‡è·å–Embyæ•°é‡é…ç½®
  EMBY_COUNT: ${{ secrets.EMBY_COUNT }}  

jobs:
  modify:
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.GH_TOKEN }}
    steps:
      - name: æ£€å‡ºä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: é…ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: å®‰è£…ç³»ç»Ÿä¾èµ–
        run: |
          sudo apt-get install -y jq curl

      - name: æ¸…ç†å†å²è®°å½•
        run: |
          set -euo pipefail
          RUNS=$(curl -sLf --retry 3 -H "Authorization: Bearer $GH_TOKEN" "https://api.github.com/repos/${{ github.repository }}/actions/runs?per_page=100" || true)
          OLD_RUNS=$(echo "$RUNS" | jq -r '.workflow_runs | sort_by(.run_number) | reverse | .[1:] | map(select(.status == "completed")) | .[] | .id' 2>/dev/null)
          [ -n "$OLD_RUNS" ] && echo "ğŸ—‘ï¸ æ¸…ç†å†å²è®°å½•" && echo "$OLD_RUNS" | xargs -I{} curl -sLf -X DELETE -H "Authorization: Bearer $GH_TOKEN" "https://api.github.com/repos/${{ github.repository }}/actions/runs/{}"

      - name: ä¸‹è½½åŸå§‹JSONæ•°æ®
        run: |
          set -euxo pipefail
          curl -fsSL --retry 1 -o ${{ env.ORIGINAL_JSON }} "https://9280.kstore.space/wex.json"
          jq empty ${{ env.ORIGINAL_JSON }}

      - name: æå–Spiderå†…å®¹
        if: github.event_name != 'workflow_dispatch'
        id: spider
        run: |
          set -euxo pipefail
          SPIDER_CONTENT=$(jq -e -r '.spider // "" | gsub("\n"; "\\n")' ${{ env.ORIGINAL_JSON }})
          echo "SPIDER_CONTENT=$SPIDER_CONTENT" >> $GITHUB_ENV

      - name: è·å–å†å²Spider
        if: github.event_name != 'workflow_dispatch'
        id: history
        run: |
          set -euxo pipefail
          RESP=$(curl -sfL --retry 3 -H "Authorization: Bearer $GH_TOKEN" \
            "https://api.github.com/repos/${{ github.repository }}/releases/latest" || true)
          
          PREVIOUS_SPIDER=$(jq -r '
            if .message == "Not Found" then
              "no_history"
            else
              (.body | split("Spiderå†…å®¹: ")[1] // "")
            end' <<< "$RESP")

          echo "PREVIOUS_SPIDER=$PREVIOUS_SPIDER" >> $GITHUB_ENV

      - name: å†…å®¹å¯¹æ¯”
        id: comparator
        run: |
          set -euxo pipefail
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            if [[ "$SPIDER_CONTENT" != "$PREVIOUS_SPIDER" ]]; then
              echo "changed=true" >> $GITHUB_OUTPUT
            else
              echo "changed=false" >> $GITHUB_OUTPUT
            fi
          fi

      - name: å¤„ç†JSONæ•°æ®
        if: steps.comparator.outputs.changed == 'true'
        run: |
          set -euxo pipefail
          python3 <<EOF
          import json
          import os
          from datetime import datetime, timezone, timedelta

          INPUT_FILE = "${{ env.ORIGINAL_JSON }}"
          OUTPUT_FILE = "${{ env.FINAL_JSON }}"

          # è§£æEMBY_COUNTï¼šæ— é…ç½®/éæ•°å­—è§†ä¸º0
          emby_count_str = os.environ.get("EMBY_COUNT", "")
          try:
              emby_count = int(emby_count_str) if emby_count_str else 0
          except ValueError:
              print("âš ï¸ EMBY_COUNTä¸æ˜¯æœ‰æ•ˆæ•°å­—ï¼Œè§†ä¸º0ï¼ˆä¸ä¿®æ”¹Embyé…ç½®ï¼‰")
              emby_count = 0

          # å®šä¹‰æ˜¯å¦éœ€è¦æ›¿æ¢åŸå§‹Embyï¼ˆâ‰¥2æ—¶æ›¿æ¢ï¼‰
          replace_original_emby = emby_count >= 2

          NAME_MAPPING = {
              "Douban": "ğŸ®ã€æ¨èã€‘ğŸ®",
              "Wexokconfig": "ğŸ®é…ç½®ä¸­å¿ƒğŸ®",
              "Wexnullname": "ğŸ’“è§‚å½±â”ƒ4KğŸ’“",
              "push_agent": "æ¨é€"
          }

          PRIORITY_MAP = {
              "Douban": 1,
              "Wexokconfig": 2,
              "ç©å¶": 3
          }

          key_delete = json.loads(os.environ.get("key_DELETE", "[]"))
          switch_douban = os.environ.get("SWITCH_DOUBAN", "false").lower() == "true"
          douban_ext = os.environ.get("DOUBAN_ext", "")
          event_type = os.environ.get("EVENT_TYPE", "")

          special_mods = {}
          if switch_douban and douban_ext:
              special_mods["Douban"] = {
                  "name": NAME_MAPPING.get("Douban", "Douban"),
                  "ext": douban_ext
              }

          try:
              with open(INPUT_FILE, "r", encoding="utf-8") as f:
                  data = json.load(f)

              # å¤„ç†proxyè§„åˆ™
              if "rules" in data:
                  for rule in data["rules"]:
                      if rule.get("name") == "proxy" and "hosts" in rule:
                          if "hdhive.online" not in rule["hosts"]:
                              rule["hosts"].append("hdhive.online")
                              print("âœ… å·²æ·»åŠ  hdhive.online åˆ°proxyè§„åˆ™çš„hostsä¸­")
                      elif rule.get("name") == "proxy" and "pattern" in rule:
                          if not any("hdhive.online" in p for p in rule["pattern"]):
                              rule["pattern"].append("hdhive.online")
                              print("âœ… å·²æ·»åŠ  hdhive.online åˆ°proxyè§„åˆ™çš„patternä¸­")

              # ç§»é™¤å†—ä½™å­—æ®µ
              data.pop("doh", None)
              data.pop("lives", None)

              sites = data.get("sites", [])
              processed_sites = []
              push_agent = None
              wexconfig = None
              original_emby_index = -1  # è®°å½•åŸå§‹Embyï¼ˆWexembyï¼‰çš„ä½ç½®ç´¢å¼•

              # ç¬¬ä¸€æ¬¡éå†ï¼šæ”¶é›†é™¤åŸå§‹Embyå¤–çš„é…ç½®ï¼Œè®°å½•åŸå§‹Embyçš„ä½ç½®
              for idx, site in enumerate(sites):
                  key = site.get("key")
                  if key == "Wexemby":
                      original_emby_index = idx  # è®°å½•åŸå§‹Embyçš„ä½ç½®
                      print(f"ğŸ” å‘ç°åŸå§‹Embyé…ç½®ï¼ˆä½ç½®ï¼š{idx}ï¼‰ï¼Œå¾…å¤„ç†")
                      continue  # æš‚ä¸æ·»åŠ åˆ°processed_sites
                  processed_sites.append(site)

              # ç¬¬äºŒæ¬¡å¤„ç†ï¼šæ ¹æ®æ¡ä»¶æ›¿æ¢æˆ–ä¿ç•™åŸå§‹Emby
              if not replace_original_emby:
                  # æƒ…å†µ1ï¼šEMBY_COUNT<2 â†’ ä¿ç•™åŸå§‹Embyï¼Œæ’å…¥åˆ°åŸä½ç½®
                  if original_emby_index != -1:
                      # æ‰¾åˆ°åŸå§‹ä½ç½®å¹¶æ’å…¥
                      original_emby = sites[original_emby_index]
                      processed_sites.insert(original_emby_index, original_emby)
                      print(f"âœ… ä¿ç•™åŸå§‹Embyé…ç½®ï¼ˆä½ç½®ï¼š{original_emby_index}ï¼‰")
              else:
                  # æƒ…å†µ2ï¼šEMBY_COUNTâ‰¥2 â†’ ä¸ä¿ç•™åŸå§‹Embyï¼Œåœ¨åŸä½ç½®æ’å…¥æ–°é…ç½®
                  if original_emby_index != -1:
                      print(f"ğŸ“Œ åœ¨åŸå§‹Embyä½ç½®ï¼ˆ{original_emby_index}ï¼‰æ·»åŠ {emby_count}ä¸ªæ–°é…ç½®")
                      # ç”Ÿæˆæ–°Embyé…ç½®å¹¶æ’å…¥åŸä½ç½®
                      new_embys = []
                      for i in range(1, emby_count + 1):
                          new_emby = {
                              "key": f"Wexdiyemby{str(i).zfill(3)}",
                              "name": f"ğŸ€„ï¸emby{i}â”ƒ4KğŸ€„ï¸",
                              "type": 3,
                              "api": "csp_WexdiyembyGuard",
                              "searchable": 1,
                              "changeable": 1,
                              "ext": {
                                  "embynumber": i
                              }
                          }
                          new_embys.append(new_emby)
                          print(f"âœ… ç”Ÿæˆæ–°Embyé…ç½®: {new_emby['key']}")
                      # æ’å…¥åŸä½ç½®ï¼ˆå¤šä¸ªæ–°é…ç½®æŒ‰é¡ºåºæ’å…¥ï¼‰
                      for i, emb in enumerate(reversed(new_embys)):
                          processed_sites.insert(original_emby_index, emb)
                  else:
                      print("âš ï¸ æœªæ‰¾åˆ°åŸå§‹Embyé…ç½®ï¼ˆWexembyï¼‰ï¼Œç›´æ¥æ·»åŠ æ–°é…ç½®åˆ°æœ«å°¾")
                      # è‹¥åŸå§‹Embyä¸å­˜åœ¨ï¼Œç›´æ¥æ·»åŠ åˆ°æœ«å°¾
                      for i in range(1, emby_count + 1):
                          new_emby = {
                              "key": f"Wexdiyemby{str(i).zfill(3)}",
                              "name": f"ğŸ€„ï¸emby{i}â”ƒ4KğŸ€„ï¸",
                              "type": 3,
                              "api": "csp_WexdiyembyGuard",
                              "searchable": 1,
                              "changeable": 1,
                              "ext": {
                                  "embynumber": i
                              }
                          }
                          processed_sites.append(new_emby)
                          print(f"âœ… ç”Ÿæˆæ–°Embyé…ç½®: {new_emby['key']}")

              # å•ç‹¬å¤„ç†push_agentå’ŒWexconfigï¼ˆæš‚å­˜åé‡æ–°æ·»åŠ ï¼Œç¡®ä¿ä½ç½®åœ¨æœ€åï¼‰
              # å…ˆä»processed_sitesä¸­ç§»é™¤æš‚å­˜çš„é…ç½®
              temp_sites = []
              for site in processed_sites:
                  key = site.get("key")
                  if key == "push_agent":
                      push_agent = site
                      continue
                  if key == "Wexconfig":
                      wexconfig = site
                      continue
                  temp_sites.append(site)
              processed_sites = temp_sites

              # åº”ç”¨åç§°æ˜ å°„å’Œç‰¹æ®Šä¿®æ”¹
              final_sites = []
              for site in processed_sites:
                  key = site.get("key")
                  # è¿‡æ»¤éœ€è¦åˆ é™¤çš„key
                  if key in key_delete:
                      continue
                  # åº”ç”¨ç‰¹æ®Šä¿®æ”¹
                  if key in special_mods:
                      site.update(special_mods[key])
                  # åç§°æ˜ å°„å¤„ç†
                  if key in NAME_MAPPING:
                      new_name = NAME_MAPPING[key]
                      if key == "push_agent" and event_type != "workflow_dispatch":
                          current_date = datetime.now(timezone(timedelta(hours=8))).strftime("%mÂ·%d")
                          new_name += f"{current_date}"
                      site["name"] = new_name
                  final_sites.append(site)

              # æŒ‰ä¼˜å…ˆçº§æ’åº
              final_sites.sort(key=lambda x: PRIORITY_MAP.get(x.get("key"), 4))

              # æœ€åæ·»åŠ Wexconfigå’Œpush_agent
              if wexconfig:
                  final_sites.append(wexconfig)
              if push_agent:
                  final_sites.append(push_agent)

              # ä¿å­˜å¤„ç†åçš„JSON
              data["sites"] = final_sites
              with open(OUTPUT_FILE, "w", encoding="utf-8") as f:
                  json.dump(data, f, ensure_ascii=False, indent=2, sort_keys=False)

              print(f"âœ… å¤„ç†å®Œæˆï¼Œè¾“å‡ºæ–‡ä»¶ï¼š{OUTPUT_FILE}")

          except json.JSONDecodeError as e:
              print(f"âŒ JSONè§£æé”™è¯¯: {e}")
              exit(1)
          except Exception as e:
              print(f"âŒ å¤„ç†å¤±è´¥: {str(e)}")
              exit(1)
          EOF

      - name: ä¸Šä¼ è‡³å‡¯é€Ÿå¹³å°
        if: steps.comparator.outputs.changed == 'true'
        run: |
          set -euxo pipefail
          echo "ğŸ“¤ å¼€å§‹ä¸Šä¼ è‡³å‡¯é€Ÿå¹³å°: ${{ env.FINAL_JSON }}"
          curl -sSf --retry 3 \
            -F "file=@${{ env.FINAL_JSON }}" \
            "https://upload.kstore.space/upload/${{ secrets.KSTORE_ID }}?access_token=${{ secrets.KSTORE_TOKEN }}"

      - name: åˆ›å»ºç‰ˆæœ¬å‘å¸ƒ
        if: steps.comparator.outputs.changed == 'true' && github.event_name != 'workflow_dispatch'
        run: |
          set -euxo pipefail
          TIMESTAMP=$(date +%s)
          gh release create "v$TIMESTAMP" \
            --title "$(date +%F)" \
            --notes "Spiderå†…å®¹: $SPIDER_CONTENT" \
            ${{ env.ORIGINAL_JSON }} \
            --target ${{ github.sha }}
