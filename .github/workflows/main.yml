name: Wex JSON Upload

on:
  push:
    branches:
      - main
  workflow_dispatch:
  schedule:
    - cron: '*/45 * * * *'

env:
  ORIGINAL_JSON: "9280.json"
  FINAL_JSON: "wex.json"         # ä¸ä¿®æ”¹Emby
  FINAL_JSON_ME: "wexme.json"    # å«Embyå¤šé…ç½®
  SWITCH_DOUBAN: ${{ secrets.SWITCH_DOUBAN }}
  #æ¨èé“¾æ¥
  DOUBAN_ext: ${{ secrets.DOUBAN_ext }}
  #éœ€è¦åˆ é™¤çš„
  key_DELETE: ${{ secrets.key_DELETE }}
  #å‡¯é€Ÿè·¯å¾„
  KSTORE_ID: ${{ secrets.KSTORE_ID }}
  #å‡¯é€Ÿå¯†é’¥
  KSTORE_TOKEN: ${{ secrets.KSTORE_TOKEN }}
  # ä»ç¯å¢ƒå˜é‡è·å–Embyæ•°é‡é…ç½®
  EMBY_COUNT: ${{ secrets.EMBY_COUNT }}
  # æ·»åŠ äº‹ä»¶ç±»å‹ç¯å¢ƒå˜é‡
  EVENT_TYPE: ${{ github.event_name }}

jobs:
  modify:
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.GH_TOKEN }}
    steps:
      - name: æ£€å‡ºä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: å®‰è£…Pythonä¾èµ–ï¼ˆå¦‚éœ€ï¼‰
        run: pip3 install beautifulsoup4 requests

      - name: å®‰è£…ç³»ç»Ÿä¾èµ–
        run: |
          sudo apt-get install -y jq curl grep sed

      - name: æ¸…ç†å†å²è®°å½•
        run: |
          set -euo pipefail
          RUNS=$(curl -sLf --retry 3 -H "Authorization: Bearer $GH_TOKEN" "https://api.github.com/repos/${{ github.repository }}/actions/runs?per_page=100" || true)
          OLD_RUNS=$(echo "$RUNS" | jq -r '.workflow_runs | sort_by(.run_number) | reverse | .[1:] | map(select(.status == "completed")) | .[] | .id' 2>/dev/null)
          [ -n "$OLD_RUNS" ] && echo "ğŸ—‘ï¸ æ¸…ç†å†å²è®°å½•" && echo "$OLD_RUNS" | xargs -I{} curl -sLf -X DELETE -H "Authorization: Bearer $GH_TOKEN" "https://api.github.com/repos/${{ github.repository }}/actions/runs/{}"

      - name: ä¸‹è½½HTMLå¹¶æå–JSONï¼ˆPythonä¼˜åŒ–ç‰ˆï¼‰
        run: |
          set -euxo pipefail
          # é…ç½®å‚æ•°
          HTML_URL="https://www.xn--sss604efuw.com/jm/jiemi.php?url=http://tv.999888987.xyz"
          OUTPUT_JSON="${{ env.ORIGINAL_JSON }}"
          
          # ç”¨Pythonè„šæœ¬å®ç°æå–ï¼ˆä¼˜åŠ¿ï¼šJSONè§£ææ›´ç²¾å‡†ï¼Œæ”¯æŒå¤æ‚HTMLï¼‰
          python3 <<EOF
          import requests
          import json
          import re
          from bs4 import BeautifulSoup  # å¦‚éœ€è§£æå¤æ‚HTMLï¼Œå¯å®‰è£…bs4ï¼ˆä¸‹æ–¹æœ‰å®‰è£…å‘½ä»¤ï¼‰
          
          # 1. ä¸‹è½½HTMLï¼ˆæ”¯æŒé‡è¯•ã€è¶…æ—¶ã€è¯ä¹¦å¿½ç•¥ï¼‰
          session = requests.Session()
          session.verify = False  # å¿½ç•¥HTTPSè¯ä¹¦è­¦å‘Š
          try:
              response = session.get(
                  url="$HTML_URL",
                  timeout=30,
                  allow_redirects=True,
                  headers={"User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36"}
              )
              response.raise_for_status()  # æŠ›å‡ºHTTPé”™è¯¯ï¼ˆå¦‚404ã€500ï¼‰
              html_content = response.text
              print(f"âœ… æˆåŠŸä¸‹è½½HTMLï¼Œå¤§å°ï¼š{len(html_content)} å­—èŠ‚")
          except Exception as e:
              print(f"âŒ ä¸‹è½½HTMLå¤±è´¥ï¼š{str(e)}")
              exit(1)
          
          # 2. æå–JSONæ ¸å¿ƒé€»è¾‘ï¼ˆä¸¤ç§æ¨¡å¼ï¼ŒæŒ‰éœ€é€‰æ‹©ï¼‰
          def extract_json_from_html(html):
              # æ¨¡å¼1ï¼šæå–æ‰€æœ‰{}åŒ…è£¹çš„å†…å®¹ï¼Œç­›é€‰æœ€é•¿åˆæ³•JSONï¼ˆé€‚åˆJSONç›´æ¥æ¸²æŸ“ï¼‰
              json_pattern = r'\{[^{}]+\}'  # åŒ¹é…{}åŒ…è£¹çš„å†…å®¹ï¼ˆéè´ªå©ªï¼‰
              json_candidates = re.findall(json_pattern, html, re.DOTALL)
              
              # æ‹¼æ¥æ‰€æœ‰å€™é€‰ç‰‡æ®µï¼ˆå¤„ç†JSONè¢«åˆ†å‰²çš„æƒ…å†µï¼‰
              full_candidate = ''.join(json_candidates)
              
              # å°è¯•è§£æä¸ºJSONï¼Œè¿”å›ç¬¬ä¸€ä¸ªåˆæ³•çš„å®Œæ•´å¯¹è±¡
              try:
                  # å…ˆå°è¯•ç›´æ¥è§£æï¼ˆå®Œæ•´JSONï¼‰
                  return json.loads(full_candidate)
              except json.JSONDecodeError:
                  # æ¨¡å¼2ï¼šç²¾å‡†åŒ¹é…é¡¶å±‚JSONå¯¹è±¡ï¼ˆä»ç¬¬ä¸€ä¸ª{åˆ°æœ€åä¸€ä¸ª}ï¼‰
                  start_idx = html.find('{')
                  end_idx = html.rfind('}')
                  if start_idx == -1 or end_idx == -1 or start_idx >= end_idx:
                      raise ValueError("æœªæ‰¾åˆ°å®Œæ•´JSONè¾¹ç•Œ")
                  json_str = html[start_idx:end_idx+1]
                  # æ¸…ç†å¤šä½™å­—ç¬¦ï¼ˆæ³¨é‡Šã€ç©ºæ ¼ç­‰ï¼‰
                  json_str = re.sub(r'//.*?$', '', json_str, flags=re.MULTILINE)  # å»é™¤//æ³¨é‡Š
                  json_str = re.sub(r'\s+', ' ', json_str)  # åˆå¹¶å¤šä½™ç©ºæ ¼
                  return json.loads(json_str)
          
          # 3. æ‰§è¡Œæå–å¹¶éªŒè¯
          try:
              json_data = extract_json_from_html(html_content)
              print(f"âœ… æˆåŠŸæå–JSONï¼ŒåŒ…å«å­—æ®µï¼š{list(json_data.keys())}")
          except Exception as e:
              print(f"âŒ æå–JSONå¤±è´¥ï¼š{str(e)}")
              print("HTMLå†…å®¹é¢„è§ˆï¼š", html_content[:2000])  # è¾“å‡ºå‰2000å­—ç¬¦ä¾¿äºæ’æŸ¥
              exit(1)
          
          # 4. å†™å…¥æ–°JSONæ–‡ä»¶ï¼ˆæ ¼å¼åŒ–è¾“å‡ºï¼Œä¾¿äºæŸ¥çœ‹ï¼‰
          try:
              with open("$OUTPUT_JSON", 'w', encoding='utf-8') as f:
                  json.dump(json_data, f, ensure_ascii=False, indent=2)
              print(f"âœ… æˆåŠŸå†™å…¥JSONæ–‡ä»¶ï¼š{OUTPUT_JSON}")
              print(f"æ–‡ä»¶å¤§å°ï¼š{len(open('$OUTPUT_JSON', 'r').read())} å­—èŠ‚")
          except Exception as e:
              print(f"âŒ å†™å…¥JSONæ–‡ä»¶å¤±è´¥ï¼š{str(e)}")
              exit(1)
          EOF

      - name: æå–Spiderå†…å®¹
        if: github.event_name != 'workflow_dispatch'
        id: spider
        run: |
          set -euxo pipefail
          SPIDER_CONTENT=$(jq -e -r '.spider // "" | gsub("\n"; "\\n")' ${{ env.ORIGINAL_JSON }})
          echo "SPIDER_CONTENT=$SPIDER_CONTENT" >> $GITHUB_ENV

      - name: è·å–å†å²Spider
        if: github.event_name != 'workflow_dispatch'
        id: history
        run: |
          set -euxo pipefail
          RESP=$(curl -sfL --retry 3 -H "Authorization: Bearer $GH_TOKEN" \
            "https://api.github.com/repos/${{ github.repository }}/releases/latest" || true)
          
          PREVIOUS_SPIDER=$(jq -r '
            if .message == "Not Found" then
              "no_history"
            else
              (.body | split("Spiderå†…å®¹: ")[1] // "")
            end' <<< "$RESP")

          echo "PREVIOUS_SPIDER=$PREVIOUS_SPIDER" >> $GITHUB_ENV

      - name: å†…å®¹å¯¹æ¯”
        id: comparator
        run: |
          set -euxo pipefail
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            if [[ "$SPIDER_CONTENT" != "$PREVIOUS_SPIDER" ]]; then
              echo "changed=true" >> $GITHUB_OUTPUT
            else
              echo "changed=false" >> $GITHUB_OUTPUT
            fi
          fi

      - name: å¤„ç†JSONæ•°æ®ï¼ˆç”Ÿæˆwex.jsonå’Œwexme.jsonï¼‰
        if: steps.comparator.outputs.changed == 'true'
        run: |
          set -euxo pipefail
          python3 <<EOF
          import json
          import os
          import copy
          from datetime import datetime, timezone, timedelta

          INPUT_FILE = "${{ env.ORIGINAL_JSON }}"
          OUTPUT_FILE_WEX = "${{ env.FINAL_JSON }}"         # ä¸ä¿®æ”¹Emby
          OUTPUT_FILE_WEXME = "${{ env.FINAL_JSON_ME }}"   # å«Embyå¤šé…ç½®

          # è§£æEMBY_COUNTï¼šæ— é…ç½®/éæ•°å­—è§†ä¸º0
          emby_count_str = os.environ.get("EMBY_COUNT", "")
          try:
              emby_count = int(emby_count_str) if emby_count_str else 0
          except ValueError:
              print("âš ï¸ EMBY_COUNTä¸æ˜¯æœ‰æ•ˆæ•°å­—ï¼Œè§†ä¸º0")
              emby_count = 0

          # å®šä¹‰æ˜¯å¦éœ€è¦æ›¿æ¢åŸå§‹Embyï¼ˆâ‰¥2æ—¶æ›¿æ¢ï¼Œä»…ç”¨äºwexme.jsonï¼‰
          replace_original_emby = emby_count >= 2

          NAME_MAPPING = {
              "Douban": "ğŸ®ã€æ¨èã€‘ğŸ®",
              "Wexokconfig": "ğŸ®é…ç½®ä¸­å¿ƒğŸ®",
              "Wexnullname": "ğŸ’“è§‚å½±â”ƒ4KğŸ’“",
              "push_agent": "æ¨é€"
          }

          PRIORITY_MAP = {
              "Douban": 1,
              "Wexokconfig": 2,
              "ç©å¶": 3
          }

          key_delete = json.loads(os.environ.get("key_DELETE", "[]"))
          switch_douban = os.environ.get("SWITCH_DOUBAN", "false").lower() == "true"
          douban_ext = os.environ.get("DOUBAN_ext", "")
          event_type = os.environ.get("EVENT_TYPE", "")

          special_mods = {}
          if switch_douban and douban_ext:
              special_mods["Douban"] = {
                  "name": NAME_MAPPING.get("Douban", "Douban"),
                  "ext": douban_ext
              }

          try:
              with open(INPUT_FILE, "r", encoding="utf-8") as f:
                  original_data = json.load(f)

              # å¤åˆ¶åŸå§‹æ•°æ®ç”¨äºä¸¤ä¸ªæ–‡ä»¶çš„å¤„ç†
              data_wex = copy.deepcopy(original_data)
              data_wexme = copy.deepcopy(original_data)

              # é€šç”¨å¤„ç†å‡½æ•°ï¼ˆæ¥æ”¶æ•°æ®å’Œæ˜¯å¦å¤„ç†Embyçš„æ ‡å¿—ï¼‰
              def process_data(data, process_emby):
                  # å¤„ç†proxyè§„åˆ™ï¼ˆé€šç”¨ï¼‰
                  if "rules" in data:
                      for rule in data["rules"]:
                          if rule.get("name") == "proxy" and "hosts" in rule:
                              if "hdhive.online" not in rule["hosts"]:
                                  rule["hosts"].append("hdhive.online")
                                  print("âœ… å·²æ·»åŠ  hdhive.online åˆ°proxyè§„åˆ™çš„hostsä¸­")
                          elif rule.get("name") == "proxy" and "pattern" in rule:
                              if not any("hdhive.online" in p for p in rule["pattern"]):
                                  rule["pattern"].append("hdhive.online")
                                  print("âœ… å·²æ·»åŠ  hdhive.online åˆ°proxyè§„åˆ™çš„patternä¸­")

                  # ç§»é™¤å†—ä½™å­—æ®µï¼ˆé€šç”¨ï¼‰
                  data.pop("doh", None)
                  data.pop("lives", None)

                  sites = data.get("sites", [])
                  processed_sites = []
                  push_agent = None
                  wexconfig = None
                  original_emby_index = -1  # è®°å½•åŸå§‹Embyï¼ˆWexembyï¼‰çš„ä½ç½®ç´¢å¼•

                  # ç¬¬ä¸€æ¬¡éå†ï¼šæ”¶é›†é™¤åŸå§‹Embyå¤–çš„é…ç½®ï¼Œè®°å½•åŸå§‹Embyçš„ä½ç½®
                  for idx, site in enumerate(sites):
                      key = site.get("key")
                      if key == "Wexemby":
                          original_emby_index = idx  # è®°å½•åŸå§‹Embyçš„ä½ç½®
                          print(f"ğŸ” å‘ç°åŸå§‹Embyé…ç½®ï¼ˆä½ç½®ï¼š{idx}ï¼‰")
                          continue  # æš‚ä¸æ·»åŠ åˆ°processed_sites
                      processed_sites.append(site)

                  # å¤„ç†Embyé…ç½®ï¼ˆä»…å½“process_embyä¸ºTrueæ—¶æ‰§è¡Œï¼‰
                  if process_emby:
                      if replace_original_emby:
                          # æ›¿æ¢åŸå§‹Embyï¼šåœ¨åŸä½ç½®æ’å…¥æ–°é…ç½®
                          if original_emby_index != -1:
                              print(f"ğŸ“Œ åœ¨åŸå§‹Embyä½ç½®ï¼ˆ{original_emby_index}ï¼‰æ·»åŠ {emby_count}ä¸ªæ–°é…ç½®ï¼ˆwexme.jsonï¼‰")
                              new_embys = []
                              for i in range(1, emby_count + 1):
                                  new_emby = {
                                      "key": f"Wexdiyemby{str(i).zfill(3)}",
                                      "name": f"ğŸ€„ï¸emby{i}â”ƒ4KğŸ€„ï¸",
                                      "type": 3,
                                      "api": "csp_WexdiyembyGuard",
                                      "searchable": 1,
                                      "changeable": 1,
                                      "ext": {
                                          "embynumber": i - 1
                                      }
                                  }
                                  new_embys.append(new_emby)
                              # æ’å…¥åŸä½ç½®
                              for emb in reversed(new_embys):
                                  processed_sites.insert(original_emby_index, emb)
                          else:
                              # åŸå§‹Embyä¸å­˜åœ¨ï¼Œç›´æ¥æ·»åŠ åˆ°æœ«å°¾
                              for i in range(1, emby_count + 1):
                                  new_emby = {
                                      "key": f"Wexdiyemby{str(i).zfill(3)}",
                                      "name": f"ğŸ€„ï¸emby{i}â”ƒ4KğŸ€„ï¸",
                                      "type": 3,
                                      "api": "csp_WexdiyembyGuard",
                                      "searchable": 1,
                                      "changeable": 1,
                                      "ext": {
                                          "embynumber": i - 1
                                      }
                                  }
                                  processed_sites.append(new_emby)
                      else:
                          # ä¸æ›¿æ¢ä½†ä¿ç•™åŸå§‹Embyï¼ˆä»…å½“process_embyä¸ºTrueä¸”count<2æ—¶ï¼‰
                          if original_emby_index != -1:
                              # ä¿®æ­£ï¼šä»åŸå§‹ç«™ç‚¹åˆ—è¡¨ä¸­è·å–åŸå§‹Embyé…ç½®
                              original_emby = next((s for s in sites if s.get("key") == "Wexemby"), None)
                              if original_emby:
                                  processed_sites.insert(original_emby_index, original_emby)
                  else:
                      # ä¸å¤„ç†Embyï¼ˆwex.jsonï¼‰ï¼šä¿ç•™åŸå§‹Emby
                      if original_emby_index != -1:
                          # ä¿®æ­£ï¼šä»åŸå§‹ç«™ç‚¹åˆ—è¡¨ä¸­è·å–åŸå§‹Embyé…ç½®
                          original_emby = next((s for s in sites if s.get("key") == "Wexemby"), None)
                          if original_emby:
                              processed_sites.insert(original_emby_index, original_emby)
                              print(f"âœ… ä¿ç•™åŸå§‹Embyé…ç½®ï¼ˆwex.jsonï¼‰")

                  # å•ç‹¬å¤„ç†push_agentå’ŒWexconfigï¼ˆæš‚å­˜åé‡æ–°æ·»åŠ ï¼Œç¡®ä¿ä½ç½®åœ¨æœ€åï¼‰
                  temp_sites = []
                  for site in processed_sites:
                      key = site.get("key")
                      if key == "push_agent":
                          push_agent = site
                          continue
                      if key == "Wexconfig":
                          wexconfig = site
                          continue
                      temp_sites.append(site)
                  processed_sites = temp_sites

                  # åº”ç”¨åç§°æ˜ å°„å’Œç‰¹æ®Šä¿®æ”¹
                  final_sites = []
                  for site in processed_sites:
                      key = site.get("key")
                      # è¿‡æ»¤éœ€è¦åˆ é™¤çš„key
                      if key in key_delete:
                          continue
                      # åº”ç”¨ç‰¹æ®Šä¿®æ”¹
                      if key in special_mods:
                          site.update(special_mods[key])
                      # åç§°æ˜ å°„å¤„ç†
                      if key in NAME_MAPPING:
                          new_name = NAME_MAPPING[key]
                          # å¤„ç†push_agentçš„æ›´æ–°æ—¶é—´
                          if key == "push_agent":
                              # è‡ªåŠ¨æ›´æ–°ï¼ˆéworkflow_dispatchï¼‰æ—¶æ·»åŠ æ—¥æœŸ
                              if event_type != "workflow_dispatch":
                                  # æ ¼å¼åŒ–ä¸º"7.25"æ ·å¼
                                  current_date = datetime.now(timezone(timedelta(hours=8))).strftime("%-m.%d")
                                  new_name += current_date
                          site["name"] = new_name
                      final_sites.append(site)

                  # æŒ‰ä¼˜å…ˆçº§æ’åº
                  final_sites.sort(key=lambda x: PRIORITY_MAP.get(x.get("key"), 4))

                  # æœ€åæ·»åŠ Wexconfigå’Œpush_agent
                  if wexconfig:
                      final_sites.append(wexconfig)
                  
                  if push_agent:
                      # å¤„ç†push_agentçš„åç§°
                      if push_agent.get("key") == "push_agent":
                          base_name = NAME_MAPPING.get("push_agent", "æ¨é€")
                          if event_type != "workflow_dispatch":
                              current_date = datetime.now(timezone(timedelta(hours=8))).strftime("%-m.%d")
                              push_agent["name"] = base_name + current_date
                          else:
                              push_agent["name"] = base_name
                      final_sites.append(push_agent)

                  data["sites"] = final_sites
                  return data

              # ç”Ÿæˆwex.jsonï¼ˆä¸å¤„ç†Embyï¼Œprocess_emby=Falseï¼‰
              data_wex_processed = process_data(data_wex, process_emby=False)
              with open(OUTPUT_FILE_WEX, "w", encoding="utf-8") as f:
                  json.dump(data_wex_processed, f, ensure_ascii=False, indent=2, sort_keys=False)
              print(f"âœ… ç”Ÿæˆ {OUTPUT_FILE_WEX}ï¼ˆä¸ä¿®æ”¹Embyï¼‰")

              # ç”Ÿæˆwexme.jsonï¼ˆå¤„ç†Embyï¼Œprocess_emby=Trueï¼‰
              data_wexme_processed = process_data(data_wexme, process_emby=True)
              with open(OUTPUT_FILE_WEXME, "w", encoding="utf-8") as f:
                  json.dump(data_wexme_processed, f, ensure_ascii=False, indent=2, sort_keys=False)
              print(f"âœ… ç”Ÿæˆ {OUTPUT_FILE_WEXME}ï¼ˆå«Embyå¤šé…ç½®ï¼‰")

          except json.JSONDecodeError as e:
              print(f"âŒ JSONè§£æé”™è¯¯: {e}")
              exit(1)
          except Exception as e:
              print(f"âŒ å¤„ç†å¤±è´¥: {str(e)}")
              exit(1)
          EOF

      - name: ä¸Šä¼ è‡³å‡¯é€Ÿå¹³å°ï¼ˆä¸¤ä¸ªæ–‡ä»¶ï¼‰
        if: steps.comparator.outputs.changed == 'true'
        run: |
          set -euxo pipefail
          # ä¸Šä¼ wex.jsonï¼ˆä¸ä¿®æ”¹Embyï¼‰
          echo "ğŸ“¤ ä¸Šä¼  ${{ env.FINAL_JSON }} è‡³å‡¯é€Ÿå¹³å°"
          curl -sSf --retry 3 \
            -F "file=@${{ env.FINAL_JSON }}" \
            "https://upload.kstore.space/upload/${{ secrets.KSTORE_ID }}?access_token=${{ secrets.KSTORE_TOKEN }}"
          
          # ä¸Šä¼ wexme.jsonï¼ˆå«Embyå¤šé…ç½®ï¼‰
          echo "ğŸ“¤ ä¸Šä¼  ${{ env.FINAL_JSON_ME }} è‡³å‡¯é€Ÿå¹³å°"
          curl -sSf --retry 3 \
            -F "file=@${{ env.FINAL_JSON_ME }}" \
            "https://upload.kstore.space/upload/${{ secrets.KSTORE_ID }}?access_token=${{ secrets.KSTORE_TOKEN }}"

      - name: åˆ›å»ºç‰ˆæœ¬å‘å¸ƒ
        if: steps.comparator.outputs.changed == 'true' && github.event_name != 'workflow_dispatch'
        run: |
          set -euxo pipefail
          TIMESTAMP=$(date +%s)
          gh release create "v$TIMESTAMP" \
            --title "$(date +%F)" \
            --notes "Spiderå†…å®¹: $SPIDER_CONTENT" \
            ${{ env.FINAL_JSON }} ${{ env.FINAL_JSON_ME }} \
            --target ${{ github.sha }}
            --notes "Spiderå†…å®¹: $SPIDER_CONTENT" \
            ${{ env.FINAL_JSON }} ${{ env.FINAL_JSON_ME }} \
            --target ${{ github.sha }}
